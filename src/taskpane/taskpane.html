<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procurement Workflow</title>
    
    <!-- Office.js library -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    
    <!-- MSAL.js for Microsoft Graph authentication -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js" type="text/javascript"></script>
    
    <!-- Fluent UI for consistent Microsoft styling -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"/>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="taskpane.css"/>
</head>
<body class="ms-Fabric">
    <div id="app-container">
        
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="../../assets/hexa-logo.png" 
                     onerror="this.src='https://hexa-outlook-frontend.vercel.app/assets/hexa-logo.png'; this.onerror=null;" 
                     alt="Hexa Logo" class="header-logo"/>
                <span class="header-brand">Hexa</span>
            </div>
            <div class="header-actions">
                <!-- Auth Status -->
                <div id="auth-status" class="auth-status">
                    <button id="sign-in-btn" class="ms-Button ms-Button--primary sign-in-btn">
                        <span class="ms-Button-label">Sign In</span>
                    </button>
                    <div id="user-info" class="user-info hidden">
                        <span id="user-name" class="user-name"></span>
                        <button id="sign-out-btn" class="ms-Button ms-Button--icon" title="Sign Out">
                            <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--SignOut"></i></span>
                        </button>
                    </div>
                </div>
                <button id="refresh-btn" class="ms-Button ms-Button--icon" title="Refresh">
                    <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Refresh"></i></span>
                </button>
                <button id="settings-btn" class="ms-Button ms-Button--icon" title="Settings">
                    <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Settings"></i></span>
                </button>
            </div>
        </header>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p id="loading-message">Loading...</p>
        </div>

        <!-- Error Banner -->
        <div id="error-banner" class="error-banner hidden">
            <span id="error-message"></span>
            <button id="dismiss-error" class="ms-Button ms-Button--icon">
                <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
            </button>
        </div>

        <!-- Success Banner -->
        <div id="success-banner" class="success-banner hidden">
            <span id="success-message"></span>
            <button id="dismiss-success" class="ms-Button ms-Button--icon">
                <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
            </button>
        </div>

        <!-- Info Banner -->
        <div id="pin-reminder-banner" class="pin-reminder-banner">
            <div class="pin-reminder-content">
                <span><strong>Quick access:</strong> Click the <strong>Apps</strong> button (grid icon) → <strong>Procurement Workflow</strong> to reopen this panel anytime.</span>
            </div>
            <button id="dismiss-pin-reminder" class="ms-Button ms-Button--icon dismiss-pin-btn" title="Dismiss">
                <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
            </button>
        </div>

        <!-- ==================== CONTEXT-BASED MODE CONTAINERS ==================== -->
        
        <!-- Draft Mode - Shown when user is viewing/editing a draft RFQ email -->
        <div id="draft-mode" class="mode-container hidden">
            <div class="mode-header">
                <div class="mode-icon"></div>
                <h2>RFQ Draft Editor</h2>
            </div>
            <div class="mode-body">
                <p class="mode-description">You're viewing an RFQ draft. You can edit it directly in Outlook, then use the button below to send all RFQ drafts.</p>
                
                <!-- Pending Drafts Section (shown when there are drafts to send) -->
                <div id="draft-list-section" class="draft-list-section">
                    <h3>RFQ Drafts Ready to Send</h3>
                    <div id="pending-drafts-list" class="pending-drafts-list">
                        <p class="loading-text">Loading drafts...</p>
                    </div>
                </div>
                
                <div id="draft-actions-section" class="draft-actions">
                    <button id="send-all-drafts-btn" class="ms-Button ms-Button--primary ms-Button--large">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Send"></i></span>
                        <span class="ms-Button-label">Send All RFQ Drafts</span>
                    </button>
                    <p class="warning-text">Sending will close this panel when the current draft is sent. Reopen the add-in to see results.</p>
                </div>
                
                <!-- Send Progress Section (shown during/after sending) -->
                <div id="draft-send-status" class="draft-send-status hidden">
                    <div class="status-progress">
                        <span id="draft-progress-text">Sending...</span>
                        <div class="progress-bar">
                            <div id="draft-progress-fill" class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                
                <!-- RFQ Progress Tracker (shown after RFQs are sent) -->
                <div id="rfq-progress-tracker" class="rfq-progress-tracker hidden">
                    <h3>RFQ Progress</h3>
                    
                    <!-- Sent RFQs -->
                    <div class="progress-item">
                        <div class="progress-item-header">
                            <span class="progress-icon"></span>
                            <span class="progress-label">RFQs Sent</span>
                            <span id="sent-rfq-count" class="progress-count">0</span>
                        </div>
                        <div class="progress-bar small">
                            <div id="sent-rfq-progress" class="progress-fill" style="width: 100%; background: #107c10;"></div>
                        </div>
                    </div>
                    
                    <!-- Auto-Replies Scheduled -->
                    <div class="progress-item">
                        <div class="progress-item-header">
                            <span class="progress-icon"></span>
                            <span class="progress-label">Auto-Replies Scheduled</span>
                            <span id="auto-replies-scheduled-count" class="progress-count">0</span>
                        </div>
                        <div class="progress-bar small">
                            <div id="auto-replies-scheduled-progress" class="progress-fill" style="width: 0%; background: #0078d4;"></div>
                        </div>
                    </div>
                    
                    <!-- Replies Received -->
                    <div class="progress-item">
                        <div class="progress-item-header">
                            <span class="progress-icon"></span>
                            <span class="progress-label">Replies Received</span>
                            <span id="replies-received-count" class="progress-count">0 / 0</span>
                        </div>
                        <div class="progress-bar small">
                            <div id="replies-received-progress" class="progress-fill" style="width: 0%; background: #ca5010;"></div>
                        </div>
                    </div>
                    
                    <!-- Replies Sorted -->
                    <div class="progress-item">
                        <div class="progress-item-header">
                            <span class="progress-icon"></span>
                            <span class="progress-label">Replies Sorted to Folders</span>
                            <span id="replies-sorted-count" class="progress-count">0 / 0</span>
                        </div>
                        <div class="progress-bar small">
                            <div id="replies-sorted-progress" class="progress-fill" style="width: 0%; background: #8764b8;"></div>
                        </div>
                    </div>
                    
                    <!-- Refresh Button -->
                    <button id="refresh-progress-btn" class="ms-Button ms-Button--default" style="margin-top: 12px;">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Refresh"></i></span>
                        <span class="ms-Button-label">Refresh Progress</span>
                    </button>
                </div>
            </div>
            <div class="mode-footer">
                <button id="back-to-workflow-from-draft" class="ms-Button">
                    <span class="ms-Button-label">← Back to Workflow</span>
                </button>
            </div>
        </div>

        <!-- Clarification Mode - Shown when user clicks on a clarification email -->
        <div id="clarification-mode" class="mode-container hidden">
            <div class="mode-header clarification-header">
                <h2>Clarification Request</h2>
            </div>
            <div class="mode-body">
                <div id="clarification-email-info" class="email-info-box">
                    <p class="loading-text">Loading email details...</p>
                </div>
                
                <div id="clarification-question-section" class="question-section">
                    <h3>Supplier's Questions</h3>
                    <div id="clarification-questions-list" class="questions-list">
                        <!-- Questions will be extracted and displayed here as cards -->
                    </div>
                    <div id="clarification-question-text" class="question-box hidden">
                        <!-- Fallback: full email body if no questions parsed -->
                    </div>
                </div>
                
                <div class="clarification-actions">
                    <button id="send-to-engineer-btn" class="ms-Button">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--EngineeringGroup"></i></span>
                        <span class="ms-Button-label">Send to Engineer</span>
                    </button>
                    <button id="reply-to-supplier-btn" class="ms-Button ms-Button--primary">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Reply"></i></span>
                        <span class="ms-Button-label">Reply to Supplier</span>
                    </button>
                </div>
            </div>
            <div class="mode-footer">
                <button id="back-to-workflow-from-clarification" class="ms-Button">
                    <span class="ms-Button-label">← Back to Workflow</span>
                </button>
            </div>
        </div>

        <!-- Quote Mode - Shown when user clicks on a quote email -->
        <div id="quote-mode" class="mode-container hidden">
            <div class="mode-header quote-header">
                <div class="mode-icon"></div>
                <h2>Quote Details</h2>
            </div>
            <div class="mode-body">
                <div id="quote-email-info" class="email-info-box">
                    <p class="loading-text">Loading email details...</p>
                </div>
                
                <div id="parsed-quote-section" class="parsed-quote-section">
                    <h3>Extracted Quote Information</h3>
                    <div id="quote-loading" class="loading-indicator">
                        <div class="spinner-small"></div>
                        <span>Parsing quote data...</span>
                    </div>
                    <div id="parsed-quote-data" class="quote-data-grid hidden">
                        <div class="quote-field">
                            <label>Supplier:</label>
                            <span id="quote-supplier">-</span>
                        </div>
                        <div class="quote-field">
                            <label>Unit Price:</label>
                            <span id="quote-price" class="price-value">-</span>
                        </div>
                        <div class="quote-field">
                            <label>Total Price:</label>
                            <span id="quote-total-price" class="price-value">-</span>
                        </div>
                        <div class="quote-field">
                            <label>Lead Time:</label>
                            <span id="quote-leadtime">-</span>
                        </div>
                        <div class="quote-field">
                            <label>Validity:</label>
                            <span id="quote-validity">-</span>
                        </div>
                        <div class="quote-field">
                            <label>Payment Terms:</label>
                            <span id="quote-terms">-</span>
                        </div>
                        <div class="quote-field full-width">
                            <label>Notes:</label>
                            <span id="quote-notes">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="quote-actions">
                    <button id="compare-quotes-btn" class="ms-Button ms-Button--primary">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Compare"></i></span>
                        <span class="ms-Button-label">Compare All Quotes</span>
                    </button>
                    <button id="accept-quote-btn" class="ms-Button">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Accept"></i></span>
                        <span class="ms-Button-label">Accept Quote</span>
                    </button>
                </div>
            </div>
            <div class="mode-footer">
                <button id="back-to-workflow-from-quote" class="ms-Button">
                    <span class="ms-Button-label">← Back to Workflow</span>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="main-content">

            <!-- ==================== RFQ WORKFLOW ==================== -->
            <section id="rfq-workflow-tab">
                
                <!-- Step 1: Select PR -->
                <div id="step-select-pr" class="workflow-step">
                    <h2 class="ms-font-l step-header clickable-step-title" id="pr-step-title">
                        <span class="step-number">1</span>
                        <span class="step-title-text">Select Purchase Requisition</span>
                    </h2>
                </div>

                <!-- Step 2: Select Suppliers -->
                <div id="step-select-suppliers" class="workflow-step disabled">
                    <h2 class="ms-font-l step-header clickable-step-title" id="supplier-step-title">
                        <span class="step-number">2</span>
                        <span class="step-title-text">Select Suppliers</span>
                    </h2>
                </div>

                <!-- Step 3: Generate RFQs -->
                <div id="step-generate-rfqs" class="workflow-step disabled">
                    <h2 class="ms-font-l step-header clickable-step-title" id="generate-rfqs-step-title">
                        <span class="step-number">3</span>
                        <span class="step-title-text">Generate RFQs</span>
                    </h2>
                </div>

                <!-- Step 4: Review & Send RFQs -->
                <div id="step-review-rfqs" class="workflow-step disabled">
                    <h2 class="ms-font-l step-header">
                        <span class="step-number">4</span>
                        Review & Send RFQs
                    </h2>
                    <div class="step-content">
                        <div id="rfq-list" class="rfq-cards-container">
                            <!-- RFQ cards will be inserted here -->
                        </div>
                    </div>
                </div>

            </section>

            <!-- ==================== EMAIL PROCESSING ==================== -->
            <section id="email-processing-tab" class="hidden">
                
                <!-- Current Email Info -->
                <div id="current-email-section" class="email-section">
                    <h2 class="ms-font-l">Current Email</h2>
                    <div id="current-email-info" class="email-info-card">
                        <p class="placeholder-text">Select an email to process</p>
                    </div>
                </div>

                <!-- Classification Section -->
                <div id="classification-section" class="email-section">
                    <h2 class="ms-font-l">Classification</h2>
                    <div id="classification-result" class="classification-card hidden">
                        <div class="classification-badge" id="classification-badge"></div>
                        <p id="classification-confidence"></p>
                    </div>
                    <button id="classify-email-btn" class="ms-Button ms-Button--primary">
                        <span class="ms-Button-label">Classify Email</span>
                    </button>
                </div>

                <!-- Processing Actions -->
                <div id="processing-section" class="email-section hidden">
                    <h2 class="ms-font-l">Actions</h2>
                    
                    <!-- Quote Processing -->
                    <div id="quote-processing" class="processing-card hidden">
                        <h3>Quote Detected</h3>
                        <p>Extract quote details from this email</p>
                        <button id="extract-quote-btn" class="ms-Button ms-Button--primary">
                            <span class="ms-Button-label">Extract Quote</span>
                        </button>
                        <div id="extracted-quote-details" class="quote-details hidden"></div>
                    </div>

                    <!-- Clarification Processing -->
                    <div id="clarification-processing" class="processing-card hidden">
                        <h3>Clarification Request</h3>
                        <div id="clarification-details">
                            <p><strong>Sub-classification:</strong> <span id="sub-classification"></span></p>
                            <p><strong>Question:</strong></p>
                            <div id="clarification-question" class="question-box"></div>
                        </div>
                        
                        <!-- Procurement Response -->
                        <div id="procurement-response" class="hidden">
                            <h4>Suggested Response:</h4>
                            <textarea id="suggested-response" class="ms-TextField-field" rows="6"></textarea>
                            <div class="action-buttons">
                                <button id="send-response-btn" class="ms-Button ms-Button--primary">
                                    <span class="ms-Button-label">Create Draft Reply</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Engineering Forward -->
                        <div id="engineering-forward" class="hidden">
                            <p class="info-text">This question requires engineering review.</p>
                            <button id="forward-to-engineering-btn" class="ms-Button ms-Button--primary">
                                <span class="ms-Button-label">Forward to Engineering</span>
                            </button>
                        </div>
                    </div>

                    <!-- Engineer Response Processing -->
                    <div id="engineer-response-processing" class="processing-card hidden">
                        <h3>Engineer Response Detected</h3>
                        <p>Generate supplier response based on engineer's input</p>
                        <button id="process-engineer-response-btn" class="ms-Button ms-Button--primary">
                            <span class="ms-Button-label">Generate Supplier Response</span>
                        </button>
                        <div id="engineer-draft-response" class="hidden">
                            <h4>Draft Response to Supplier:</h4>
                            <textarea id="engineer-draft-body" class="ms-TextField-field" rows="6"></textarea>
                            <button id="create-engineer-draft-btn" class="ms-Button ms-Button--primary">
                                <span class="ms-Button-label">Create Draft Reply</span>
                            </button>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ==================== QUOTE COMPARISON ==================== -->
            <section id="quote-comparison-tab" class="hidden">
                
                <div class="quote-comparison-header">
                    <h2 class="ms-font-l">Compare Quotes</h2>
                    <button id="refresh-quotes-btn" class="ms-Button ms-Button--icon" title="Refresh Quotes">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Refresh"></i></span>
                    </button>
                </div>

                <div id="quotes-container" class="quote-comparison-container">
                    <p class="placeholder-text">Loading quotes from all Quotes folders...</p>
                </div>

                <div id="quote-summary" class="quote-summary hidden">
                    <h3>Summary</h3>
                    <div id="summary-content" class="summary-grid"></div>
                </div>

            </section>

        </main>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button id="close-settings" class="ms-Button ms-Button--icon">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Pin Taskpane Setting -->
                    <div class="setting-group pin-setting">
                        <label class="setting-label-header">
                            <input type="checkbox" id="pin-taskpane" />
                            <strong>Keep add-in open when changing emails</strong>
                        </label>
                        <p class="setting-description" id="pin-status">
                            Enable this to keep the add-in panel visible as you navigate between emails.
                        </p>
                    </div>
                    
                    <hr class="setting-divider"/>
                    
                    <div class="setting-group">
                        <label for="api-url">Backend API URL:</label>
                        <input type="text" id="api-url" class="ms-TextField-field" value="https://hexa-outlook-backend.onrender.com"/>
                    </div>
                    <div class="setting-group">
                        <label for="engineering-email">Engineering Team Email:</label>
                        <input type="email" id="engineering-email" class="ms-TextField-field" placeholder="engineering@company.com"/>
                    </div>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="auto-classify" checked/>
                            Auto-classify incoming emails
                        </label>
                    </div>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="auto-create-folders" checked/>
                            Auto-create folder structure
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="save-settings" class="ms-Button ms-Button--primary">
                        <span class="ms-Button-label">Save Settings</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- RFQ Preview Modal -->
        <div id="rfq-preview-modal" class="modal hidden">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>RFQ Preview</h2>
                    <button id="close-rfq-preview" class="ms-Button ms-Button--icon">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="rfq-preview-section">
                        <label>To:</label>
                        <input type="email" id="preview-to" class="ms-TextField-field" readonly/>
                    </div>
                    <div class="rfq-preview-section">
                        <label>Subject:</label>
                        <input type="text" id="preview-subject" class="ms-TextField-field"/>
                    </div>
                    <div class="rfq-preview-section">
                        <label>Body:</label>
                        <textarea id="preview-body" class="ms-TextField-field" rows="15"></textarea>
                    </div>
                    <div class="rfq-preview-section">
                        <label>Attachments:</label>
                        <div id="preview-attachments" class="attachments-list"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="create-draft-btn" class="ms-Button">
                        <span class="ms-Button-label">Create Draft</span>
                    </button>
                    <button id="finalize-send-btn" class="ms-Button ms-Button--primary">
                        <span class="ms-Button-label">Finalize & Send</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Supplier Selection Modal -->
        <div id="supplier-selection-modal" class="modal hidden supplier-modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Select Suppliers</h2>
                    <button id="close-supplier-modal" class="ms-Button ms-Button--icon">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="supplier-modal-header">
                        <div class="supplier-search-section">
                            <input type="text" id="supplier-search" placeholder="Search suppliers..." class="ms-TextField-field"/>
                        </div>
                        <div class="supplier-modal-actions">
                            <span id="supplier-count">0 suppliers found</span>
                        </div>
                    </div>
                    <div class="supplier-action-bar">
                        <button id="add-new-supplier-btn" class="ms-Button">
                            <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Add"></i></span>
                            <span class="ms-Button-label">Add New Supplier</span>
                        </button>
                    </div>
                    <div id="supplier-list" class="selectable-list checkbox-list supplier-modal-list">
                        <!-- Supplier items will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="modal-footer-center">
                        <span id="selected-count-display">0 selected</span>
                    </div>
                    <div class="modal-footer-right">
                        <button id="apply-supplier-selection" class="ms-Button ms-Button--primary">
                            <span class="ms-Button-label">Done</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Requisition Selection Modal -->
        <div id="pr-selection-modal" class="modal hidden pr-modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Select Purchase Requisition</h2>
                    <button id="close-pr-modal" class="ms-Button ms-Button--icon">
                        <span class="ms-Button-icon"><i class="ms-Icon ms-Icon--Cancel"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="pr-modal-header">
                        <div class="pr-search-section">
                            <input type="text" id="pr-search" placeholder="Search PRs..." class="ms-TextField-field"/>
                        </div>
                    </div>
                    <div id="pr-list" class="selectable-list pr-modal-list">
                        <!-- PR items will be inserted here -->
                    </div>
                    <div id="selected-pr-info" class="selected-item-info hidden">
                        <h3>Selected PR:</h3>
                        <div id="pr-details"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="apply-pr-selection" class="ms-Button ms-Button--primary">
                        <span class="ms-Button-label">Done</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript Files -->
    <!-- Environment variables (injected at build time) -->
    <script src="../env-config.js"></script>
    <script src="../services/auth.js"></script>
    <script src="../services/config.js"></script>
    <script src="../services/api-client.js"></script>
    <script src="../services/email-operations.js"></script>
    <script src="../services/folder-management.js"></script>
    <script src="../services/email-monitor.js"></script>
    <script src="../services/openai-service.js"></script>
    <script src="../utils/helpers.js"></script>
    <script src="taskpane.js"></script>
</body>
</html>
